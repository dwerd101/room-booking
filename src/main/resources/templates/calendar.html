<html lang="ru"xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="robots" content="index, follow" />
    <META http-equiv="Content-Type" content="text/html; charset=windows-1251">
    <meta name="description" content="Метровагонмаш - производит вагоны метро, дизель поезда, рельсовые автобусы." />
    <link
            href="/css/userpagestyle.css"
            type="text/css" data-template-style="true" rel="stylesheet" />
            <link href='/css/calendar.css' rel='stylesheet' />
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src='/js/calendar.js'></script>
    <title>ВКС</title>
</head>
<body>
  <header>
    <nav class="nav">
        <a href="/index.html" class="b-nav__logo hidden-sm hidden-xs">
            <img width="223" src="/img/logo_rus.gif" height="41" alt="Метровагонмаш">
        </a>
        <div class="auth-panel">
            <h2>
                <a sec:authorize="isAnonymous()" class="btn btn-outline-secondary" href="/auth/login" role="button">Вход</a>
                <a sec:authorize="isAuthenticated()" class="btn btn-outline-secondary" href="/auth/logout" role="button">Выход</a>
            </h2>
        </div>
    </nav>
</header>
  
<script src='/locales/ru.js'></script>

<script>
  document.getElementById('datePicker').value = new Date().toDateInputValue();
</script>

<script>

  document.addEventListener('DOMContentLoaded', function() {
    var initialLocaleCode = 'ru';
    var localeSelectorEl = document.getElementById('locale-selector');
    var calendarEl = document.getElementById('calendar');
    var url = window.location.href;
    var urlMassive = url.split('/');
    var index = urlMassive[urlMassive.length-1];

    var calendar = new FullCalendar.Calendar(calendarEl, {
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      locale: initialLocaleCode,
      buttonIcons: false, // show the prev/next text
      weekNumbers: true,
      initialDate: '2020-09-12',
      navLinks: true, // can click day/week names to navigate views
      selectable: true,
      selectMirror: true,
      select: async function (arg) {
          var title = prompt('Event Title:');
          if (title) {
              calendar.addEvent({
                  title: title,
                  start: arg.start,
                  end: arg.end,
                  allDay: arg.allDay
              })
              const url = '/record/save';
            //  const data = arg.event;
              let data = {
                  title: title,
                  start: arg.start,
                  end: arg.end,
                  allDay: arg.allDay,
                  roomId: window.location.href
              }

              try {
                  const response = await fetch(url, {
                      method: 'POST', // или 'PUT'
                      body: JSON.stringify(data), // данные могут быть 'строкой' или {объектом}!
                      headers: {
                          'Content-Type': 'application/json'
                      }
                  });
                  const json = await response.json();
                  console.log('Успех:', JSON.stringify(json));
                  window.location.reload(true);
              } catch (error) {
                  console.error('Ошибка:', error);
              }
          }
          calendar.unselect()
      },
      eventClick: async function (arg) {
          if (confirm('Are you sure you want to delete this event?')) {
              arg.event.remove()
              const url = '/record/delete/';
             let data = arg.event;
             /* let data = {
                  start: arg.start,
                  end: arg.end,
                  allDay: arg.allDay
              }*/

              try {
                  const response = await fetch(url, {
                      method: 'DELETE', // или 'PUT'
                      body: JSON.stringify(data), // данные могут быть 'строкой' или {объектом}!
                      headers: {
                          'Content-Type': 'application/json'
                      }
                  });
                  const json = await response.json();
                  console.log('Успех:', JSON.stringify(json));
              } catch (error) {
                  console.error('Ошибка:', error);
              }
          }
      },
      editable: true,
      dayMaxEvents: true, // allow "more" link when too many events

      eventSources: [

    // your event source
    {
      url: '/record/'+index
        // use the `url` property
    }

    // any other sources...

  ]

    });

    calendar.render();
  });

  

</script>
<style>

  body {
    margin: 100px 10px;
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: 810px;
    margin: 0 auto;
  }

</style>

<div id='top'>
  
<div id='calendar'></div>

</body>
</html>
